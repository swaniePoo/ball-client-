package me.dinozoid.strife.module.implementations.exploit;

import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import me.dinozoid.strife.Client;
import me.dinozoid.strife.alpine.listener.EventHandler;
import me.dinozoid.strife.alpine.listener.Listener;
import me.dinozoid.strife.event.implementations.network.PacketInboundEvent;
import me.dinozoid.strife.event.implementations.player.PlayerMotionEvent;
import me.dinozoid.strife.module.Category;
import me.dinozoid.strife.module.Module;
import me.dinozoid.strife.module.ModuleInfo;
import me.dinozoid.strife.property.Property;
import me.dinozoid.strife.property.implementations.DoubleProperty;
import me.dinozoid.strife.ui.notification.Notification;
import me.dinozoid.strife.util.network.HttpUtil;
import me.dinozoid.strife.util.player.ChatFormatting;
import me.dinozoid.strife.util.system.TimerUtil;
import net.minecraft.client.gui.GuiIngameMenu;
import net.minecraft.network.play.server.S02PacketChat;

import java.util.concurrent.CompletableFuture;

@ModuleInfo(name = "StaffAnalyzer", renderName = "StaffAnalyzer", category = Category.EXPLOIT)
public class StaffAnalyzerModule extends Module {

    private final DoubleProperty checkIntervalProperty = new DoubleProperty("Interval", 15, 10, 900, 10, Property.Representation.INT);

    private int staffBans;
    private final TimerUtil timerUtil = new TimerUtil();
    private boolean recievedAPIKey;
    private String apiKey;

    @EventHandler
    private final Listener<PacketInboundEvent> packetInboundListener = new Listener<>(event -> {
        if (event.getPacket() instanceof S02PacketChat) {
            S02PacketChat chat = event.getPacket();
            String message = ChatFormatting.stripFormatting(chat.getChatComponent().getFormattedText());
            if (message.startsWith("Your new API key is ")) {
                apiKey = message.replace("Your new API key is ", "");
                recievedAPIKey = true;
            }
        }
    });

    @EventHandler
    private final Listener<PlayerMotionEvent> updatePlayerListener = new Listener<>(event -> {
        if (!(mc.currentScreen instanceof GuiIngameMenu) && mc.currentScreen != null) return;
        if (timerUtil.hasElapsed(checkIntervalProperty.getValue().longValue() * 1000) && recievedAPIKey && mc.thePlayer.ticksExisted > 1) {
            CompletableFuture<HttpUtil.HttpResponse> completableFuture = HttpUtil.asyncHttpsConnection("https://api.hypixel.net/punishmentstats?key=" + apiKey);
            completableFuture.whenCompleteAsync((response, throwable) -> {
                JsonObject object = JsonParser.parseString(response.content()).getAsJsonObject();
                int lastStaffBans = staffBans;
                if (object.has("staff_total"))
                    staffBans = object.get("staff_total").getAsInt();
                int banDifference = staffBans - lastStaffBans;
                if (banDifference >= 0 && lastStaffBans != 0)
                    Client.INSTANCE.getNotificationRepository().display(new Notification(Notification.NotificationType.WARNING, "Staff Analyzer", "Staff has banned " + banDifference + " players in the last " + checkIntervalProperty.getValue().intValue() + " seconds."));
            });
            timerUtil.reset();
        }
    });

    public String apiKey() {
        return apiKey;
    }
    public boolean recievedAPIKey() {
        return recievedAPIKey;
    }
    public void recievedAPIKey(boolean recievedAPIKey) {
        this.recievedAPIKey = recievedAPIKey;
    }
}
